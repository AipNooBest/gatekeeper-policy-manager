<!doctype html>
<!--
 Copyright (c) 2020 SIGHUP s.r.l All rights reserved.
 Use of this source code is governed by a BSD-style
 license that can be found in the LICENSE file.
-->

<html lang="en">

<head>
  <title>Gatekeeper Policy Manager - {{ title }} Violations Report</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='user-tie.svg', _external=True) }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/fomantic-ui-css/semantic.min.css', _external=True) }}">
  <style>
    .footer.segment {
      padding: 5em 0em;
      margin-top: 10em !important;
    }
  </style>
</head>

<body>
    {% if constraints|length == 0 %}
    <div class="ui segments">
        <div class="ui secondary header segment">
            <i class="ui info icon"></i> There are no Constraint defined
        </div>
        <div class="ui blue segment">
            We didn't find any Constraint CRDs defined in the cluster.
        </div>
    </div>
    {% else %}
    {% set limited_view = [] %}
    <div class="ui fluid container">
        <div class="ui attached segments">
        <h1 class="ui centered top attached header">GPM - Constraints Violations Report</h1>
        <div class="ui segment">
            <table class="ui compact selectable striped table">
                <thead>
                    <tr>
                    <th>Constraint</th>
                    <th>Action</th>
                    <th>Kind</th>
                    <th>Namespace</th>
                    <th>Name</th>
                    <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                {% for constraint in constraints %}
                    {% if constraint.status.totalViolations is defined and constraint.status.totalViolations > 0 %}
                        {% if constraint.status.totalViolations > constraint.status.violations|length %}
                        {{ limited_view.append(constraint.metadata.name) or '' }}
                        {% endif %}
                        {% for violation in constraint.status.violations %}
                        <tr onclick="this.classList.toggle('active');">
                        <td>{{ constraint.metadata.name }}</td>
                        <td><span class="ui {% if violation.enforcementAction == 'deny' %}red{% else %}orange{% endif %} text">{{ violation.enforcementAction }}</span></td>
                        <td>{{ violation.kind }}</td>
                        <td>{{ violation.namespace }}</td>
                        <td>{{ violation.name }}</td>
                        <td>{{ violation.message }}</td>
                        </tr>
                        {% endfor %}
                    {% elif constraint.status.totalViolations is not defined %}
                    <div class="ui segment"><i class="ui grey icon circle question"></i> Violations for this Constraint are unkown. This probably means that the Constraint has not been processed by Gatekeeper yet. Please, try refreshing the page.</div>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% if limited_view %}
        <div class="ui warning very small icon attached message">
            <i class="exclamation triangle icon"></i>
            <div class="content">
                <div class="header">Not all violations are being shown</div>
                Gatekeeper's configuration is limiting the amount of audit violations being shown for Constraints <strong>{{ limited_view|join(', ') }}</strong>.
                <br/>See Gatekeeper's <span style="font-family: monospace">--constraint-violations-limit</span> audit configuration flag.
            </div>
        </div>
        {% endif %}
        <div class="ui center aligned segment">
            <p>violations report generated by GPM running at {{ url_for('index', _external=True) }} on {{ timestamp }}</p>
        </div>
        {% endif %}
    </div>
</div>
</body>
</html>